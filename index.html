<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle Financeiro - Offline First</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .stat-card {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
        
        .expense-item {
            transition: all 0.2s ease;
        }
        
        .expense-item:hover {
            background-color: #f8fafc !important;
            transform: translateX(5px);
        }
        
        /* Scrollbar personalizada */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #c7d2fe;
            border-radius: 10px;
        }
        
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #a5b4fc;
        }
        
        /* Anima√ß√µes */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-out;
        }
        
        /* Loading spinner */
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #4f46e5;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Status da sincroniza√ß√£o */
        .sync-status {
            position: fixed;
            bottom: 20px;
            left: 20px;
            z-index: 1000;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .sync-online {
            background: #10b981;
            color: white;
        }
        
        .sync-offline {
            background: #ef4444;
            color: white;
        }
        
        .sync-pending {
            background: #f59e0b;
            color: white;
        }
        
        .sync-icon {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
    </style>
</head>
<body class="p-4 md:p-8">
    <!-- Status da Sincroniza√ß√£o -->
    <div id="syncStatus" class="sync-status sync-online hidden">
        <i class="fas fa-sync sync-icon"></i>
        <span id="syncText">Sincronizado</span>
    </div>

    <div id="appContainer" class="max-w-6xl mx-auto">
        <!-- Cabe√ßalho -->
        <header class="mb-8 text-center md:text-left">
            <div class="flex flex-col md:flex-row justify-between items-center mb-6">
                <div>
                    <h1 class="text-3xl md:text-4xl font-bold text-white">
                        <i class="fas fa-wallet mr-3"></i>Controle Financeiro
                    </h1>
                    <p class="text-white/80 mt-2">Gerencie suas despesas com sincroniza√ß√£o autom√°tica</p>
                </div>
                <div class="mt-4 md:mt-0 flex items-center space-x-4">
                    <div class="flex items-center space-x-2 bg-white/20 backdrop-blur-sm rounded-full px-4 py-2">
                        <i class="fas fa-database text-white"></i>
                        <span id="deviceIdDisplay" class="text-white text-sm font-medium">Dispositivo Local</span>
                    </div>
                    <button id="manualSync" class="bg-white/20 hover:bg-white/30 backdrop-blur-sm rounded-full px-4 py-2 text-white text-sm transition">
                        <i class="fas fa-sync mr-1"></i> Sincronizar Agora
                    </button>
                </div>
            </div>
            
            <!-- Cart√µes de Status -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                <div class="stat-card card rounded-2xl p-6">
                    <div class="flex items-center">
                        <div class="rounded-full bg-indigo-100 p-3 mr-4">
                            <i class="fas fa-calendar-alt text-indigo-600 text-xl"></i>
                        </div>
                        <div>
                            <p class="text-gray-500 text-sm">Total do M√™s</p>
                            <p id="monthlyTotal" class="text-2xl font-bold text-gray-800">R$ 0,00</p>
                        </div>
                    </div>
                    <p class="text-xs text-gray-400 mt-3">
                        <span id="currentMonthName" class="font-medium"></span>
                    </p>
                </div>
                
                <div class="stat-card card rounded-2xl p-6">
                    <div class="flex items-center">
                        <div class="rounded-full bg-green-100 p-3 mr-4">
                            <i class="fas fa-receipt text-green-600 text-xl"></i>
                        </div>
                        <div>
                            <p class="text-gray-500 text-sm">Despesas Totais</p>
                            <p id="totalExpenses" class="text-2xl font-bold text-gray-800">0</p>
                        </div>
                    </div>
                    <p class="text-xs text-gray-400 mt-3">Todas as despesas registradas</p>
                </div>
                
                <div class="stat-card card rounded-2xl p-6">
                    <div class="flex items-center">
                        <div class="rounded-full bg-blue-100 p-3 mr-4">
                            <i class="fas fa-users text-blue-600 text-xl"></i>
                        </div>
                        <div>
                            <p class="text-gray-500 text-sm">Usu√°rio Ativo</p>
                            <p id="activeUserName" class="text-xl font-bold text-indigo-600">RONALDO</p>
                        </div>
                    </div>
                    <div class="mt-3">
                        <select id="appUserSelector" class="w-full text-sm border-gray-300 rounded-lg focus:border-indigo-500 focus:ring-indigo-500">
                            <option value="RONALDO">RONALDO</option>
                            <option value="ADRIANA">ADRIANA</option>
                        </select>
                    </div>
                </div>
                
                <div class="stat-card card rounded-2xl p-6">
                    <div class="flex items-center">
                        <div class="rounded-full bg-purple-100 p-3 mr-4">
                            <i class="fas fa-cloud text-purple-600 text-xl"></i>
                        </div>
                        <div>
                            <p class="text-gray-500 text-sm">√öltima Sinc.</p>
                            <p id="lastSyncTime" class="text-xl font-bold text-gray-800">-</p>
                        </div>
                    </div>
                    <p class="text-xs text-gray-400 mt-3">
                        <span id="syncStatusText" class="font-medium">Online</span>
                    </p>
                </div>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Coluna Esquerda: Formul√°rio e Filtros -->
            <div class="lg:col-span-1 space-y-8">
                <!-- Formul√°rio de Nova Despesa -->
                <div class="card rounded-2xl p-6 shadow-lg fade-in">
                    <h2 class="text-xl font-bold text-gray-800 mb-6 flex items-center">
                        <i class="fas fa-plus-circle mr-2 text-indigo-600"></i> Nova Despesa
                    </h2>
                    
                    <form id="expenseForm" class="space-y-5">
                        <div>
                            <label for="expenseDate" class="block text-sm font-medium text-gray-700 mb-1">
                                <i class="far fa-calendar mr-1"></i> Data
                            </label>
                            <input type="date" id="expenseDate" required
                                   class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition">
                        </div>
                        
                        <div>
                            <label for="expenseName" class="block text-sm font-medium text-gray-700 mb-1">
                                <i class="far fa-edit mr-1"></i> Descri√ß√£o
                            </label>
                            <input type="text" id="expenseName" placeholder="Ex: Supermercado, Conta de Luz" required
                                   class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition">
                        </div>
                        
                        <div>
                            <label for="expenseValue" class="block text-sm font-medium text-gray-700 mb-1">
                                <i class="fas fa-money-bill-wave mr-1"></i> Valor (R$)
                            </label>
                            <input type="number" id="expenseValue" step="0.01" min="0.01" placeholder="0,00" required
                                   class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition">
                        </div>
                        
                        <div>
                            <label for="expenseCategory" class="block text-sm font-medium text-gray-700 mb-1">
                                <i class="fas fa-tag mr-1"></i> Categoria
                            </label>
                            <select id="expenseCategory" 
                                    class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition">
                                <option value="Alimenta√ß√£o">Alimenta√ß√£o</option>
                                <option value="Moradia">Moradia</option>
                                <option value="Transporte">Transporte</option>
                                <option value="Lazer">Lazer</option>
                                <option value="Sa√∫de">Sa√∫de</option>
                                <option value="Educa√ß√£o">Educa√ß√£o</option>
                                <option value="Outros">Outros</option>
                            </select>
                        </div>
                        
                        <button type="submit" id="submitButton"
                                class="w-full bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 text-white font-semibold py-3 px-4 rounded-xl transition duration-300 transform hover:-translate-y-1 active:translate-y-0 flex items-center justify-center">
                            <i class="fas fa-paper-plane mr-2"></i>
                            <span id="submitButtonText">Salvar Despesa</span>
                        </button>
                    </form>
                </div>
                
                <!-- Filtros e Exporta√ß√£o -->
                <div class="card rounded-2xl p-6 shadow-lg fade-in">
                    <h2 class="text-xl font-bold text-gray-800 mb-6 flex items-center">
                        <i class="fas fa-filter mr-2 text-indigo-600"></i> Filtros & Exporta√ß√£o
                    </h2>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Per√≠odo</label>
                            <div class="grid grid-cols-2 gap-2">
                                <button type="button" data-filter="month" class="filter-period active bg-indigo-100 text-indigo-700 border border-indigo-300 py-2 px-3 rounded-lg text-sm font-medium transition">
                                    Este M√™s
                                </button>
                                <button type="button" data-filter="all" class="filter-period bg-gray-100 text-gray-700 border border-gray-300 py-2 px-3 rounded-lg text-sm font-medium transition">
                                    Todos
                                </button>
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Ordenar por</label>
                            <select id="sortBy" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent text-sm">
                                <option value="date-desc">Data (Mais Recente)</option>
                                <option value="date-asc">Data (Mais Antiga)</option>
                                <option value="value-desc">Valor (Maior)</option>
                                <option value="value-asc">Valor (Menor)</option>
                            </select>
                        </div>
                        
                        <div class="pt-4 border-t border-gray-200">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Exportar Dados</label>
                            <div class="grid grid-cols-2 gap-2">
                                <button id="exportData" class="bg-green-100 hover:bg-green-200 text-green-700 border border-green-300 py-2 px-3 rounded-lg text-sm font-medium transition flex items-center justify-center">
                                    <i class="fas fa-file-export mr-2"></i> Exportar
                                </button>
                                <button id="importData" class="bg-blue-100 hover:bg-blue-200 text-blue-700 border border-blue-300 py-2 px-3 rounded-lg text-sm font-medium transition flex items-center justify-center">
                                    <i class="fas fa-file-import mr-2"></i> Importar
                                </button>
                            </div>
                        </div>
                        
                        <div class="pt-4 border-t border-gray-200">
                            <button id="clearLocalData" class="w-full text-sm text-red-600 hover:text-red-800 py-2 border border-red-200 hover:border-red-300 rounded-lg transition">
                                <i class="fas fa-trash-alt mr-1"></i> Limpar Dados Locais
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Coluna Direita: Lista de Despesas -->
            <div class="lg:col-span-2">
                <div class="card rounded-2xl p-6 shadow-lg h-full fade-in">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-bold text-gray-800 flex items-center">
                            <i class="fas fa-list-alt mr-2 text-indigo-600"></i> Despesas Registradas
                        </h2>
                        <div class="flex items-center space-x-4">
                            <div class="text-sm text-gray-500">
                                <span id="expensesCount">0</span> itens
                            </div>
                            <div class="text-xs px-2 py-1 rounded-full bg-gray-100 text-gray-600">
                                <i class="fas fa-hdd mr-1"></i> Local
                            </div>
                        </div>
                    </div>
                    
                    <!-- Estados de Carregamento/Vazio -->
                    <div id="loadingState" class="hidden text-center py-12">
                        <div class="spinner mx-auto mb-4"></div>
                        <p class="text-gray-500">Carregando despesas...</p>
                    </div>
                    
                    <div id="emptyState" class="text-center py-12">
                        <div class="mx-auto mb-4 text-gray-300">
                            <i class="fas fa-receipt text-5xl"></i>
                        </div>
                        <h3 class="text-lg font-medium text-gray-700 mb-2">Nenhuma despesa encontrada</h3>
                        <p class="text-gray-500 max-w-sm mx-auto">
                            N√£o h√° despesas registradas para <span id="emptyStateUser" class="font-semibold">RONALDO</span>.
                            Comece adicionando sua primeira despesa!
                        </p>
                    </div>
                    
                    <!-- Lista de Despesas -->
                    <div id="expensesList" class="custom-scrollbar space-y-4 max-h-[calc(100vh-300px)] overflow-y-auto pr-2 hidden">
                        <!-- Despesas ser√£o injetadas aqui via JavaScript -->
                    </div>
                    
                    <!-- Resumo por Categoria -->
                    <div id="categorySummary" class="mt-8 pt-6 border-t border-gray-200 hidden">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">Resumo por Categoria</h3>
                        <div id="categoryList" class="space-y-3">
                            <!-- Categorias ser√£o injetadas aqui -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Importa√ß√£o -->
    <div id="importModal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
        <div class="card rounded-2xl p-6 m-4 max-w-md w-full">
            <h3 class="text-xl font-bold text-gray-800 mb-4">Importar Dados</h3>
            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    Selecione um arquivo JSON exportado:
                </label>
                <input type="file" id="importFile" accept=".json" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                <p class="text-xs text-gray-500 mt-2">
                    O arquivo deve estar no formato JSON exportado por este aplicativo.
                </p>
            </div>
            <div class="flex justify-end space-x-3">
                <button id="importCancel" class="px-4 py-2 text-gray-600 hover:text-gray-800 font-medium rounded-lg transition">
                    Cancelar
                </button>
                <button id="importConfirm" class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white font-medium rounded-lg transition">
                    Importar
                </button>
            </div>
        </div>
    </div>

    <!-- Toast Notifications -->
    <div id="toastContainer" class="fixed bottom-4 right-4 z-50 space-y-2 max-w-md"></div>
    
    <!-- Modal de Confirma√ß√£o -->
    <div id="confirmModal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
        <div class="card rounded-2xl p-6 m-4 max-w-sm w-full">
            <h3 class="text-xl font-bold text-gray-800 mb-2" id="modalTitle"></h3>
            <p class="text-gray-600 mb-6" id="modalMessage"></p>
            <div class="flex justify-end space-x-3">
                <button id="modalCancel" class="px-4 py-2 text-gray-600 hover:text-gray-800 font-medium rounded-lg transition">
                    Cancelar
                </button>
                <button id="modalConfirm" class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white font-medium rounded-lg transition">
                    Confirmar
                </button>
            </div>
        </div>
    </div>

    <!-- Input oculto para gerar arquivo de exporta√ß√£o -->
    <a id="downloadAnchor" style="display: none"></a>

    <script>
        // ========== CONFIGURA√á√ÉO DA API ==========
        // URL do servidor de sincroniza√ß√£o (substitua com sua URL)
        const SYNC_API_URL = 'https://seu-servidor.com/api/sync'; // Exemplo: 'http://localhost:3000/api/sync'
        
        // Chave de sincroniza√ß√£o (pode ser configurada pelo usu√°rio)
        const SYNC_API_KEY = 'controle-financeiro-2024';
        
        // Intervalo de sincroniza√ß√£o em minutos
        const SYNC_INTERVAL_MINUTES = 5;
        
        // ========== CONSTANTES DA APLICA√á√ÉO ==========
        const LOCAL_STORAGE_KEY = 'controle_financeiro_data';
        const DEVICE_ID_KEY = 'controle_financeiro_device_id';
        const LAST_SYNC_KEY = 'controle_financeiro_last_sync';
        
        // ========== ESTADO DA APLICA√á√ÉO ==========
        let expenses = [];
        let selectedAppUser = 'RONALDO';
        let currentFilter = 'month';
        let currentSort = 'date-desc';
        let deviceId = null;
        let isOnline = navigator.onLine;
        let syncInterval = null;
        let pendingSync = false;
        
        // ========== FUN√á√ïES UTILIT√ÅRIAS ==========
        
        // Gerar ID √∫nico para dispositivo
        const generateDeviceId = () => {
            return 'device_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        };
        
        // Obter ou criar deviceId
        const getDeviceId = () => {
            let id = localStorage.getItem(DEVICE_ID_KEY);
            if (!id) {
                id = generateDeviceId();
                localStorage.setItem(DEVICE_ID_KEY, id);
            }
            return id;
        };
        
        // Formata√ß√£o de moeda
        const formatCurrency = (value) => {
            return new Intl.NumberFormat('pt-BR', {
                style: 'currency',
                currency: 'BRL'
            }).format(value || 0);
        };
        
        // Formata√ß√£o de data
        const formatDate = (dateString) => {
            if (!dateString) return 'Data inv√°lida';
            const [year, month, day] = dateString.split('-');
            return `${day}/${month}/${year}`;
        };
        
        // Formata√ß√£o de timestamp
        const formatTime = (timestamp) => {
            if (!timestamp) return '-';
            const date = new Date(timestamp);
            return date.toLocaleTimeString('pt-BR', { 
                hour: '2-digit', 
                minute: '2-digit',
                day: '2-digit',
                month: '2-digit'
            });
        };
        
        // Obter nome do m√™s atual
        const getCurrentMonthName = () => {
            const date = new Date();
            return date.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });
        };
        
        // Obter in√≠cio do m√™s atual (YYYY-MM-DD)
        const getCurrentMonthStart = () => {
            const date = new Date();
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            return `${year}-${month}-01`;
        };
        
        // Gerar ID √∫nico para despesa
        const generateExpenseId = () => {
            return 'exp_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        };
        
        // Exibir toast notifications
        const showToast = (message, type = 'info') => {
            const container = document.getElementById('toastContainer');
            const id = 'toast-' + Date.now();
            
            const icons = {
                success: 'check-circle',
                error: 'exclamation-circle',
                warning: 'exclamation-triangle',
                info: 'info-circle'
            };
            
            const colors = {
                success: 'bg-green-500 border-green-600',
                error: 'bg-red-500 border-red-600',
                warning: 'bg-yellow-500 border-yellow-600',
                info: 'bg-blue-500 border-blue-600'
            };
            
            const toast = document.createElement('div');
            toast.id = id;
            toast.className = `${colors[type]} text-white p-4 rounded-xl border shadow-lg transform transition-all duration-300 translate-x-full opacity-0`;
            toast.innerHTML = `
                <div class="flex items-center">
                    <i class="fas fa-${icons[type]} mr-3 text-lg"></i>
                    <div class="flex-1">
                        <p class="font-medium">${message}</p>
                    </div>
                    <button onclick="document.getElementById('${id}').remove()" class="ml-4 text-white/80 hover:text-white">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
            
            container.appendChild(toast);
            
            // Anima√ß√£o de entrada
            setTimeout(() => {
                toast.classList.remove('translate-x-full', 'opacity-0');
                toast.classList.add('translate-x-0', 'opacity-100');
            }, 10);
            
            // Remover automaticamente ap√≥s 5 segundos
            setTimeout(() => {
                toast.classList.add('translate-x-full', 'opacity-0');
                setTimeout(() => toast.remove(), 300);
            }, 5000);
        };
        
        // Modal de confirma√ß√£o
        const showConfirmModal = (title, message) => {
            return new Promise((resolve) => {
                document.getElementById('modalTitle').textContent = title;
                document.getElementById('modalMessage').textContent = message;
                document.getElementById('confirmModal').classList.remove('hidden');
                
                document.getElementById('modalConfirm').onclick = () => {
                    document.getElementById('confirmModal').classList.add('hidden');
                    resolve(true);
                };
                
                document.getElementById('modalCancel').onclick = () => {
                    document.getElementById('confirmModal').classList.add('hidden');
                    resolve(false);
                };
            });
        };
        
        // Atualizar status da sincroniza√ß√£o
        const updateSyncStatus = (status, message = '') => {
            const syncElement = document.getElementById('syncStatus');
            const syncText = document.getElementById('syncText');
            const syncStatusText = document.getElementById('syncStatusText');
            
            syncElement.className = `sync-status sync-${status}`;
            syncText.textContent = message || status;
            syncStatusText.textContent = status.charAt(0).toUpperCase() + status.slice(1);
            
            if (status === 'online') {
                syncElement.classList.remove('hidden');
            } else if (status === 'offline') {
                syncElement.classList.remove('hidden');
            } else if (status === 'pending') {
                syncElement.classList.remove('hidden');
            }
        };
        
        // Atualizar tempo da √∫ltima sincroniza√ß√£o
        const updateLastSyncTime = () => {
            const lastSync = localStorage.getItem(LAST_SYNC_KEY);
            const lastSyncElement = document.getElementById('lastSyncTime');
            
            if (lastSync) {
                lastSyncElement.textContent = formatTime(parseInt(lastSync));
            } else {
                lastSyncElement.textContent = 'Nunca';
            }
        };
        
        // ========== ARMAZENAMENTO LOCAL ==========
        
        // Salvar dados no localStorage
        const saveToLocalStorage = () => {
            try {
                const data = {
                    version: '1.0',
                    lastUpdated: Date.now(),
                    expenses: expenses,
                    deviceId: deviceId
                };
                
                localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(data));
                console.log('üíæ Dados salvos localmente:', expenses.length, 'despesas');
                return true;
            } catch (error) {
                console.error('‚ùå Erro ao salvar no localStorage:', error);
                showToast('Erro ao salvar dados localmente', 'error');
                return false;
            }
        };
        
        // Carregar dados do localStorage
        const loadFromLocalStorage = () => {
            try {
                const savedData = localStorage.getItem(LOCAL_STORAGE_KEY);
                
                if (savedData) {
                    const data = JSON.parse(savedData);
                    
                    // Verifica vers√£o compat√≠vel
                    if (data.version === '1.0' && Array.isArray(data.expenses)) {
                        expenses = data.expenses;
                        console.log('üìÇ Dados carregados do localStorage:', expenses.length, 'despesas');
                        return true;
                    } else {
                        console.warn('‚ö†Ô∏è Dados locais em formato incompat√≠vel, iniciando novo');
                        expenses = [];
                    }
                } else {
                    console.log('üìÇ Nenhum dado local encontrado, iniciando novo');
                    expenses = [];
                }
                
                return true;
            } catch (error) {
                console.error('‚ùå Erro ao carregar do localStorage:', error);
                showToast('Erro ao carregar dados locais', 'error');
                expenses = [];
                return false;
            }
        };
        
        // Limpar dados locais
        const clearLocalData = async () => {
            if (await showConfirmModal(
                'Limpar Dados Locais',
                'Tem certeza que deseja apagar todos os dados locais? Esta a√ß√£o n√£o pode ser desfeita.'
            )) {
                localStorage.removeItem(LOCAL_STORAGE_KEY);
                expenses = [];
                updateUI();
                showToast('Dados locais limpos com sucesso', 'success');
            }
        };
        
        // ========== SINCORNIZA√á√ÉO COM API ==========
        
        // Verificar conex√£o com a internet
        const checkOnlineStatus = () => {
            const wasOnline = isOnline;
            isOnline = navigator.onLine;
            
            if (wasOnline !== isOnline) {
                if (isOnline) {
                    showToast('Conex√£o restaurada', 'success');
                    updateSyncStatus('online', 'Conectado');
                    // Tenta sincronizar ao voltar online
                    if (pendingSync) {
                        syncWithServer();
                    }
                } else {
                    showToast('Voc√™ est√° offline', 'warning');
                    updateSyncStatus('offline', 'Offline');
                }
            }
            
            return isOnline;
        };
        
        // Sincronizar com servidor
        const syncWithServer = async () => {
            if (!isOnline) {
                pendingSync = true;
                updateSyncStatus('offline', 'Aguardando conex√£o');
                return false;
            }
            
            updateSyncStatus('pending', 'Sincronizando...');
            
            try {
                // Prepara dados para envio
                const syncData = {
                    apiKey: SYNC_API_KEY,
                    deviceId: deviceId,
                    timestamp: Date.now(),
                    expenses: expenses,
                    action: 'sync' // sync, push, pull
                };
                
                // ENVIO PARA API (implementa√ß√£o do servidor necess√°ria)
                console.log('üì§ Enviando dados para sincroniza√ß√£o:', expenses.length, 'despesas');
                
                // Esta √© uma implementa√ß√£o simulada
                // Na pr√°tica, voc√™ precisaria de um servidor real
                const response = await fetch(SYNC_API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(syncData)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    
                    // Atualiza com dados recebidos do servidor
                    if (result.success && Array.isArray(result.expenses)) {
                        // Mescla dados locais com dados do servidor
                        mergeExpenses(result.expenses);
                        
                        // Salva dados mesclados localmente
                        saveToLocalStorage();
                        
                        // Atualiza UI
                        updateUI();
                        
                        // Atualiza timestamp da √∫ltima sincroniza√ß√£o
                        localStorage.setItem(LAST_SYNC_KEY, Date.now().toString());
                        updateLastSyncTime();
                        
                        pendingSync = false;
                        updateSyncStatus('online', 'Sincronizado');
                        showToast('Sincroniza√ß√£o realizada com sucesso', 'success');
                        
                        console.log('‚úÖ Sincroniza√ß√£o completa:', expenses.length, 'despesas');
                        return true;
                    }
                } else {
                    throw new Error(`Erro HTTP: ${response.status}`);
                }
                
            } catch (error) {
                console.error('‚ùå Erro na sincroniza√ß√£o:', error);
                
                // Se a API n√£o estiver dispon√≠vel, apenas mostra mensagem amig√°vel
                if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
                    showToast('Servidor de sincroniza√ß√£o indispon√≠vel', 'warning');
                    updateSyncStatus('online', 'Modo offline');
                } else {
                    showToast('Erro na sincroniza√ß√£o', 'error');
                    updateSyncStatus('online', 'Erro na sinc');
                }
                
                return false;
            }
        };
        
        // Mesclar despesas locais com do servidor
        const mergeExpenses = (serverExpenses) => {
            // Cria mapa de despesas por ID
            const expenseMap = new Map();
            
            // Adiciona despesas locais
            expenses.forEach(expense => {
                expenseMap.set(expense.id, expense);
            });
            
            // Mescla com despesas do servidor
            serverExpenses.forEach(serverExpense => {
                const localExpense = expenseMap.get(serverExpense.id);
                
                if (!localExpense) {
                    // Despesa nova do servidor
                    expenseMap.set(serverExpense.id, serverExpense);
                } else if (serverExpense.updatedAt > localExpense.updatedAt) {
                    // Despesa do servidor √© mais recente
                    expenseMap.set(serverExpense.id, serverExpense);
                }
                // Caso contr√°rio, mant√©m a local (mais recente)
            });
            
            // Converte de volta para array
            expenses = Array.from(expenseMap.values());
            
            console.log('üîÑ Dados mesclados:', expenses.length, 'despesas');
        };
        
        // Iniciar sincroniza√ß√£o peri√≥dica
        const startSyncInterval = () => {
            // Limpa intervalo anterior se existir
            if (syncInterval) {
                clearInterval(syncInterval);
            }
            
            // Configura novo intervalo (5 minutos)
            syncInterval = setInterval(() => {
                if (isOnline) {
                    syncWithServer();
                }
            }, SYNC_INTERVAL_MINUTES * 60 * 1000);
            
            console.log(`üîÑ Sincroniza√ß√£o configurada a cada ${SYNC_INTERVAL_MINUTES} minutos`);
        };
        
        // ========== EXPORTA√á√ÉO E IMPORTA√á√ÉO ==========
        
        // Exportar dados para JSON
        const exportData = () => {
            try {
                const exportData = {
                    version: '1.0',
                    exportedAt: new Date().toISOString(),
                    deviceId: deviceId,
                    expenses: expenses
                };
                
                const dataStr = JSON.stringify(exportData, null, 2);
                const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
                
                const exportFileName = `despesas_${new Date().toISOString().split('T')[0]}.json`;
                
                const linkElement = document.getElementById('downloadAnchor');
                linkElement.setAttribute('href', dataUri);
                linkElement.setAttribute('download', exportFileName);
                linkElement.click();
                
                showToast('Dados exportados com sucesso', 'success');
                
            } catch (error) {
                console.error('‚ùå Erro ao exportar dados:', error);
                showToast('Erro ao exportar dados', 'error');
            }
        };
        
        // Importar dados de JSON
        const importData = (file) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                
                reader.onload = (event) => {
                    try {
                        const importedData = JSON.parse(event.target.result);
                        
                        // Valida dados importados
                        if (importedData.version !== '1.0' || !Array.isArray(importedData.expenses)) {
                            throw new Error('Formato de arquivo inv√°lido');
                        }
                        
                        // Substitui dados locais
                        expenses = importedData.expenses;
                        
                        // Salva localmente
                        saveToLocalStorage();
                        
                        // Atualiza UI
                        updateUI();
                        
                        resolve(true);
                        
                    } catch (error) {
                        console.error('‚ùå Erro ao importar dados:', error);
                        reject(error);
                    }
                };
                
                reader.onerror = () => {
                    reject(new Error('Erro ao ler arquivo'));
                };
                
                reader.readAsText(file);
            });
        };
        
        // ========== MANIPULA√á√ÉO DE DESPESAS ==========
        
        const addExpense = (expenseData) => {
            const newExpense = {
                id: generateExpenseId(),
                date: expenseData.date,
                name: expenseData.name.trim(),
                value: parseFloat(expenseData.value),
                category: expenseData.category,
                applicationUser: selectedAppUser,
                createdAt: Date.now(),
                updatedAt: Date.now(),
                deviceId: deviceId
            };
            
            expenses.push(newExpense);
            
            // Ordena por data (mais recente primeiro)
            expenses.sort((a, b) => b.createdAt - a.createdAt);
            
            // Salva localmente
            saveToLocalStorage();
            
            // Marca para sincroniza√ß√£o
            pendingSync = true;
            
            console.log('‚ûï Nova despesa adicionada:', newExpense);
            return newExpense;
        };
        
        const deleteExpense = (expenseId) => {
            const index = expenses.findIndex(e => e.id === expenseId);
            
            if (index !== -1) {
                expenses.splice(index, 1);
                
                // Salva localmente
                saveToLocalStorage();
                
                // Marca para sincroniza√ß√£o
                pendingSync = true;
                
                console.log('üóëÔ∏è Despesa removida:', expenseId);
                return true;
            }
            
            return false;
        };
        
        // ========== ATUALIZA√á√ÉO DA UI ==========
        
        const updateUI = () => {
            updateSummary();
            filterAndSortExpenses();
            updateCategorySummary();
        };
        
        const updateSummary = () => {
            const currentMonthStart = getCurrentMonthStart().substring(0, 7);
            
            // Filtra despesas do usu√°rio atual
            const userExpenses = expenses.filter(e => e.applicationUser === selectedAppUser);
            
            // Calcula total do m√™s
            const monthlyTotal = userExpenses
                .filter(e => e.date && e.date.startsWith(currentMonthStart))
                .reduce((sum, e) => sum + e.value, 0);
            
            // Atualiza elementos
            document.getElementById('monthlyTotal').textContent = formatCurrency(monthlyTotal);
            document.getElementById('totalExpenses').textContent = userExpenses.length;
            document.getElementById('currentMonthName').textContent = getCurrentMonthName();
            document.getElementById('activeUserName').textContent = selectedAppUser;
            document.getElementById('deviceIdDisplay').textContent = `Dispositivo: ${deviceId.substring(0, 8)}...`;
        };
        
        const filterAndSortExpenses = () => {
            const currentMonthStart = getCurrentMonthStart().substring(0, 7);
            
            // Filtra por usu√°rio
            let filtered = expenses.filter(e => e.applicationUser === selectedAppUser);
            
            // Aplica filtro de per√≠odo
            if (currentFilter === 'month') {
                filtered = filtered.filter(e => e.date && e.date.startsWith(currentMonthStart));
            }
            
            // Aplica ordena√ß√£o
            filtered.sort((a, b) => {
                switch(currentSort) {
                    case 'date-desc':
                        return new Date(b.date || 0) - new Date(a.date || 0);
                    case 'date-asc':
                        return new Date(a.date || 0) - new Date(b.date || 0);
                    case 'value-desc':
                        return b.value - a.value;
                    case 'value-asc':
                        return a.value - b.value;
                    default:
                        return 0;
                }
            });
            
            renderExpensesList(filtered);
        };
        
        const renderExpensesList = (filteredExpenses) => {
            const listContainer = document.getElementById('expensesList');
            const loadingState = document.getElementById('loadingState');
            const emptyState = document.getElementById('emptyState');
            const categorySummary = document.getElementById('categorySummary');
            
            // Esconde loading
            loadingState.classList.add('hidden');
            
            // Verifica se h√° despesas
            if (filteredExpenses.length === 0) {
                listContainer.classList.add('hidden');
                categorySummary.classList.add('hidden');
                emptyState.classList.remove('hidden');
                document.getElementById('emptyStateUser').textContent = selectedAppUser;
                document.getElementById('expensesCount').textContent = '0';
                return;
            }
            
            // Mostra lista e categoria
            emptyState.classList.add('hidden');
            listContainer.classList.remove('hidden');
            categorySummary.classList.remove('hidden');
            document.getElementById('expensesCount').textContent = filteredExpenses.length;
            
            // Renderiza despesas
            listContainer.innerHTML = '';
            
            filteredExpenses.forEach(expense => {
                const categoryColors = {
                    'Alimenta√ß√£o': 'bg-red-100 text-red-800',
                    'Moradia': 'bg-blue-100 text-blue-800',
                    'Transporte': 'bg-green-100 text-green-800',
                    'Lazer': 'bg-purple-100 text-purple-800',
                    'Sa√∫de': 'bg-pink-100 text-pink-800',
                    'Educa√ß√£o': 'bg-indigo-100 text-indigo-800',
                    'Outros': 'bg-gray-100 text-gray-800'
                };
                
                const categoryClass = categoryColors[expense.category] || categoryColors.Outros;
                
                const expenseElement = document.createElement('div');
                expenseElement.className = 'expense-item card rounded-xl p-4 border border-gray-200 fade-in';
                expenseElement.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <div class="flex items-start mb-2">
                                <div class="flex-1">
                                    <h4 class="font-semibold text-gray-800">${expense.name}</h4>
                                    <div class="flex items-center mt-1 space-x-3">
                                        <span class="text-sm text-gray-500">
                                            <i class="far fa-calendar mr-1"></i>${formatDate(expense.date)}
                                        </span>
                                        <span class="text-sm px-2 py-1 rounded-full ${categoryClass}">
                                            ${expense.category}
                                        </span>
                                        <span class="text-xs text-gray-400" title="${new Date(expense.updatedAt).toLocaleString()}">
                                            <i class="far fa-clock mr-1"></i>${formatTime(expense.updatedAt)}
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="text-right ml-4">
                            <p class="text-xl font-bold text-red-600">${formatCurrency(expense.value)}</p>
                            <button class="delete-expense mt-2 text-gray-400 hover:text-red-500 transition" data-id="${expense.id}">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </div>
                    </div>
                `;
                
                listContainer.appendChild(expenseElement);
            });
            
            // Adiciona listeners para bot√µes de excluir
            document.querySelectorAll('.delete-expense').forEach(button => {
                button.addEventListener('click', async (e) => {
                    const expenseId = e.currentTarget.dataset.id;
                    const expense = expenses.find(e => e.id === expenseId);
                    
                    if (expense && await showConfirmModal(
                        'Excluir Despesa',
                        `Tem certeza que deseja excluir a despesa "${expense.name}" no valor de ${formatCurrency(expense.value)}?`
                    )) {
                        if (deleteExpense(expenseId)) {
                            updateUI();
                            showToast('Despesa exclu√≠da com sucesso', 'success');
                        }
                    }
                });
            });
        };
        
        const updateCategorySummary = () => {
            const userExpenses = expenses.filter(e => e.applicationUser === selectedAppUser);
            
            if (userExpenses.length === 0) return;
            
            const categoryTotals = {};
            const totalValue = userExpenses.reduce((sum, e) => sum + e.value, 0);
            
            userExpenses.forEach(expense => {
                const category = expense.category || 'Outros';
                categoryTotals[category] = (categoryTotals[category] || 0) + expense.value;
            });
            
            const categoryList = document.getElementById('categoryList');
            categoryList.innerHTML = '';
            
            // Ordena categorias por valor (maior primeiro)
            const sortedCategories = Object.entries(categoryTotals)
                .sort((a, b) => b[1] - a[1]);
            
            sortedCategories.forEach(([category, total]) => {
                const percentage = total > 0 ? (total / totalValue) * 100 : 0;
                
                const categoryElement = document.createElement('div');
                categoryElement.className = 'flex items-center justify-between';
                categoryElement.innerHTML = `
                    <div class="flex-1 mr-4">
                        <div class="flex justify-between mb-1">
                            <span class="text-sm font-medium text-gray-700">${category}</span>
                            <span class="text-sm font-medium text-gray-900">${formatCurrency(total)}</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div class="bg-indigo-600 h-2 rounded-full" style="width: ${percentage}%"></div>
                        </div>
                    </div>
                `;
                
                categoryList.appendChild(categoryElement);
            });
        };
        
        // ========== EVENT LISTENERS ==========
        
        // Formul√°rio de nova despesa
        document.getElementById('expenseForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const submitButton = document.getElementById('submitButton');
            const submitText = document.getElementById('submitButtonText');
            
            const date = document.getElementById('expenseDate').value;
            const name = document.getElementById('expenseName').value.trim();
            const value = parseFloat(document.getElementById('expenseValue').value);
            const category = document.getElementById('expenseCategory').value;
            
            // Valida√ß√£o
            if (!date || !name || isNaN(value) || value <= 0) {
                showToast('Preencha todos os campos corretamente', 'error');
                return;
            }
            
            // Desabilita bot√£o durante o processamento
            submitButton.disabled = true;
            submitText.textContent = 'Salvando...';
            
            // Adiciona despesa
            addExpense({
                date,
                name,
                value,
                category
            });
            
            // Reabilita bot√£o
            submitButton.disabled = false;
            submitText.textContent = 'Salvar Despesa';
            
            // Atualiza UI
            updateUI();
            
            // Limpa formul√°rio, mantendo a data atual
            document.getElementById('expenseName').value = '';
            document.getElementById('expenseValue').value = '';
            document.getElementById('expenseDate').value = new Date().toISOString().split('T')[0];
            
            showToast(`Despesa "${name}" adicionada com sucesso!`, 'success');
        });
        
        // Seletor de usu√°rio
        document.getElementById('appUserSelector').addEventListener('change', (e) => {
            selectedAppUser = e.target.value;
            updateUI();
        });
        
        // Filtros de per√≠odo
        document.querySelectorAll('.filter-period').forEach(button => {
            button.addEventListener('click', (e) => {
                document.querySelectorAll('.filter-period').forEach(b => {
                    b.classList.remove('active', 'bg-indigo-100', 'text-indigo-700', 'border-indigo-300');
                    b.classList.add('bg-gray-100', 'text-gray-700', 'border-gray-300');
                });
                
                e.target.classList.add('active', 'bg-indigo-100', 'text-indigo-700', 'border-indigo-300');
                e.target.classList.remove('bg-gray-100', 'text-gray-700', 'border-gray-300');
                
                currentFilter = e.target.dataset.filter;
                filterAndSortExpenses();
            });
        });
        
        // Ordena√ß√£o
        document.getElementById('sortBy').addEventListener('change', (e) => {
            currentSort = e.target.value;
            filterAndSortExpenses();
        });
        
        // Exportar dados
        document.getElementById('exportData').addEventListener('click', () => {
            exportData();
        });
        
        // Importar dados
        document.getElementById('importData').addEventListener('click', () => {
            document.getElementById('importModal').classList.remove('hidden');
        });
        
        // Confirmar importa√ß√£o
        document.getElementById('importConfirm').addEventListener('click', async () => {
            const fileInput = document.getElementById('importFile');
            const file = fileInput.files[0];
            
            if (!file) {
                showToast('Selecione um arquivo para importar', 'error');
                return;
            }
            
            try {
                await importData(file);
                document.getElementById('importModal').classList.add('hidden');
                fileInput.value = '';
                showToast('Dados importados com sucesso', 'success');
            } catch (error) {
                showToast('Erro ao importar arquivo: Formato inv√°lido', 'error');
            }
        });
        
        // Cancelar importa√ß√£o
        document.getElementById('importCancel').addEventListener('click', () => {
            document.getElementById('importModal').classList.add('hidden');
            document.getElementById('importFile').value = '';
        });
        
        // Limpar dados locais
        document.getElementById('clearLocalData').addEventListener('click', () => {
            clearLocalData();
        });
        
        // Sincroniza√ß√£o manual
        document.getElementById('manualSync').addEventListener('click', () => {
            syncWithServer();
        });
        
        // ========== INICIALIZA√á√ÉO DA APLICA√á√ÉO ==========
        
        document.addEventListener('DOMContentLoaded', () => {
            console.log('üöÄ Inicializando aplicativo...');
            
            // Configura data atual no formul√°rio
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('expenseDate').value = today;
            
            // Obt√©m deviceId
            deviceId = getDeviceId();
            console.log('üì± Device ID:', deviceId);
            
            // Carrega dados do localStorage
            loadFromLocalStorage();
            
            // Atualiza status online
            checkOnlineStatus();
            updateSyncStatus(isOnline ? 'online' : 'offline', isOnline ? 'Conectado' : 'Offline');
            
            // Atualiza tempo da √∫ltima sincroniza√ß√£o
            updateLastSyncTime();
            
            // Atualiza UI
            updateUI();
            
            // Inicia sincroniza√ß√£o peri√≥dica
            startSyncInterval();
            
            // Configura listeners de rede
            window.addEventListener('online', () => {
                checkOnlineStatus();
                if (pendingSync) {
                    setTimeout(() => syncWithServer(), 2000);
                }
            });
            
            window.addEventListener('offline', checkOnlineStatus);
            
            // Verifica conex√£o periodicamente
            setInterval(checkOnlineStatus, 30000);
            
            console.log('‚úÖ Aplicativo inicializado e pronto');
            showToast('Aplicativo carregado com sucesso!', 'success');
        });
        
        // ========== EXPORTA√á√ïES GLOBAIS ==========
        
        window.appControls = {
            showToast,
            formatCurrency,
            getCurrentMonthName,
            exportData,
            importData,
            syncWithServer,
            clearLocalData
        };
    </script>
</body>
</html>
